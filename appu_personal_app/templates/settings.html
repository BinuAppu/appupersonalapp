{% extends "base.html" %}

{% block content %}
<div class="header">
    <div>
        <h1>Settings ‚öôÔ∏è</h1>
        <p style="color: var(--text-muted);">Manage your application preferences and data.</p>
    </div>
</div>

<div class="settings-container" style="max-width: 900px; margin: 0 auto; padding: 1rem;">

    <!-- User Profile Section -->
    <div class="settings-section active">
        <div class="settings-section-header" onclick="toggleSettingsSection(this.parentElement)">
            <h2>User Profile</h2>
            <span class="chevron">‚ñº</span>
        </div>
        <div class="settings-section-content">
            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h4 style="margin: 0 0 5px 0;">Nick Name</h4>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">What should we call you?</p>
                </div>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="userNameInput" value="{{ user_name }}" placeholder="Enter Nickname"
                        style="padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color); width: 200px;">
                    <button class="btn" onclick="saveUserName()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Appearance Section -->
    <div class="settings-section">
        <div class="settings-section-header" onclick="toggleSettingsSection(this.parentElement)">
            <h2>Appearance</h2>
            <span class="chevron">‚ñº</span>
        </div>
        <div class="settings-section-content" style="padding-top: 1rem;">
            <!-- Theme Toggle -->
            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h4 style="margin: 0 0 5px 0;">Theme</h4>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Switch between light and dark
                        modes.</p>
                </div>
                <div class="toggle-group">
                    <label>
                        <input type="radio" name="settingsTheme" id="settingsLightTheme" value="light"
                            onchange="setTheme('light')">
                        <span style="font-size: 1.2rem; cursor: pointer;">‚òÄÔ∏è</span>
                    </label>
                    <label>
                        <input type="radio" name="settingsTheme" id="settingsDarkTheme" value="dark"
                            onchange="setTheme('dark')">
                        <span style="font-size: 1.2rem; cursor: pointer;">üåô</span>
                    </label>
                </div>
            </div>

            <!-- Color Scheme -->
            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h4 style="margin: 0 0 5px 0;">Color Scheme</h4>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Choose a vibrant color palette.
                    </p>
                </div>
                <select id="colorSchemeSelect" onchange="changeColorScheme(this.value)"
                    style="padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);">
                    <option value="default">Default</option>
                    <option value="hackthebox">Hackthebox</option>
                    <option value="dracula">Dracula</option>
                    <option value="ocean">Ocean</option>
                    <option value="solarized-light">Solarized Light</option>
                    <option value="solarized-dark">Solarized Dark</option>
                    <option value="monokai">Monokai</option>
                    <option value="nord">Nord</option>
                    <option value="gruvbox-light">Gruvbox Light</option>
                    <option value="gruvbox-dark">Gruvbox Dark</option>
                    <option value="cyberpunk">Cyberpunk</option>
                    <option value="forest">Forest</option>
                    <option value="sunset">Sunset</option>
                    <option value="midnight">Midnight</option>
                    <option value="atom-one-dark">Atom One Dark</option>
                    <option value="atom-one-light">Atom One Light</option>
                    <option value="ayu-dark">Ayu Dark</option>
                    <option value="ayu-light">Ayu Light</option>
                    <option value="ayu-mirage">Ayu Mirage</option>
                    <option value="base16-tomorrow-dark">Base16 Tomorrow Dark</option>
                    <option value="base16-tomorrow-light">Base16 Tomorrow Light</option>
                    <option value="catppuccin-latte">Catppuccin Latte</option>
                    <option value="catppuccin-frappe">Catppuccin Frappe</option>
                    <option value="catppuccin-macchiato">Catppuccin Macchiato</option>
                    <option value="catppuccin-mocha">Catppuccin Mocha</option>
                    <option value="cobalt2">Cobalt2</option>
                    <option value="darcula">Darcula</option>
                    <option value="dracula-soft">Dracula Soft</option>
                    <option value="github-dark">GitHub Dark</option>
                    <option value="github-light">GitHub Light</option>
                    <option value="jellybeans">Jellybeans</option>
                    <option value="material-darker">Material Darker</option>
                    <option value="material-lighter">Material Lighter</option>
                    <option value="material-ocean">Material Ocean</option>
                    <option value="material-palenight">Material Palenight</option>
                    <option value="monokai-pro">Monokai Pro</option>
                    <option value="night-owl">Night Owl</option>
                    <option value="shades-of-purple">Shades of Purple</option>
                    <option value="synthwave-84">Synthwave '84</option>
                    <option value="tokyo-night">Tokyo Night</option>
                    <option value="zenburn">Zenburn</option>
                    <option value="solarized-ocean">Solarized Ocean</option>
                    <option value="deep-purple">Deep Purple</option>
                    <option value="matrix-green">Matrix Green</option>
                    <option value="inferno-hacker">Inferno Hacker</option>
                </select>
            </div>

            <!-- Font Family -->
            <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h4 style="margin: 0 0 5px 0;">Font Family</h4>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Select your preferred typography.
                    </p>
                </div>
                <select id="fontFamilySelect" onchange="changeFontFamily(this.value)"
                    style="padding: 0.5rem; border-radius: 8px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color);">
                    <option value="'Inter', sans-serif">Inter</option>
                    <option value="'Roboto', sans-serif">Roboto</option>
                    <option value="'Poppins', sans-serif">Poppins</option>
                    <option value="'Montserrat', sans-serif">Montserrat</option>
                    <option value="'Source Code Pro', monospace">Source Code Pro</option>
                    <option value="'Playfair Display', serif">Playfair Display</option>
                    <option value="'Lato', sans-serif">Lato</option>
                    <option value="'Merriweather', serif">Merriweather</option>
                    <option value="'Nunito', sans-serif">Nunito</option>
                    <option value="'Open Sans', sans-serif">Open Sans</option>
                    <option value="'Quicksand', sans-serif">Quicksand</option>
                    <option value="'Raleway', sans-serif">Raleway</option>
                    <option value="'Ubuntu', sans-serif">Ubuntu</option>
                    <option value="'Work Sans', sans-serif">Work Sans</option>
                    <option value="'Inconsolata', monospace">Inconsolata</option>
                </select>
            </div>
        </div>
    </div>

    <!-- Dashboard Coloring Section -->
    <div class="settings-section">
        <div class="settings-section-header" onclick="toggleSettingsSection(this.parentElement)">
            <h2>Dashboard Coloring</h2>
            <span class="chevron">‚ñº</span>
        </div>
        <div class="settings-section-content">
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Set colors for items based on
                their deadlines.</p>

            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h4 style="margin: 0 0 5px 0;">Nearing 2 Weeks</h4>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="preview2Weeks"
                        style="width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--border-color);">
                    </div>
                    <input type="color" id="color2Weeks" oninput="updateColorPreviews()"
                        style="width: 50px; height: 35px; border: none; border-radius: 4px; cursor: pointer;">
                </div>
            </div>

            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <h4 style="margin: 0 0 5px 0;">Nearing 1 Week</h4>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="preview1Week"
                        style="width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--border-color);">
                    </div>
                    <input type="color" id="color1Week" oninput="updateColorPreviews()"
                        style="width: 50px; height: 35px; border: none; border-radius: 4px; cursor: pointer;">
                </div>
            </div>

            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h4 style="margin: 0 0 5px 0;">Overdue</h4>
                </div>
                <div style="display: flex; align-items: center; gap: 15px;">
                    <div id="previewOverdue"
                        style="width: 24px; height: 24px; border-radius: 50%; border: 1px solid var(--border-color);">
                    </div>
                    <input type="color" id="colorOverdue" oninput="updateColorPreviews()"
                        style="width: 50px; height: 35px; border: none; border-radius: 4px; cursor: pointer;">
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end;">
                <button class="btn" onclick="saveColorSettings()">Save Color Settings</button>
            </div>
        </div>
    </div>

    <!-- Dashboard Layout Section -->
    <div class="settings-section">
        <div class="settings-section-header" onclick="toggleSettingsSection(this.parentElement)">
            <h2>Dashboard Layout</h2>
            <span class="chevron">‚ñº</span>
        </div>
        <div class="settings-section-content">
            <p style="color: var(--text-muted); font-size: 0.9rem; margin-bottom: 1.5rem;">Rearrange the order of
                sections on your dashboard.</p>

            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4>Top Section</h4>
                <select id="sectionOrder0" style="width: 150px;">
                    <option value="tasks">Active Tasks</option>
                    <option value="projects">Projects</option>
                    <option value="reminders">Reminders</option>
                </select>
            </div>

            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h4>Middle Section</h4>
                <select id="sectionOrder1" style="width: 150px;">
                    <option value="tasks">Active Tasks</option>
                    <option value="projects">Projects</option>
                    <option value="reminders">Reminders</option>
                </select>
            </div>

            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h4>Bottom Section</h4>
                <select id="sectionOrder2" style="width: 150px;">
                    <option value="tasks">Active Tasks</option>
                    <option value="projects">Projects</option>
                    <option value="reminders">Reminders</option>
                </select>
            </div>

            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <h4>Timeframe</h4>
                <div style="display: flex; flex-direction: column; align-items: flex-end;">
                    <label for="settingsTimeframeSlider"
                        style="font-size: 0.8rem; color: var(--text-muted); margin-bottom: 5px;">
                        <span id="settingsTimeframeValue">6</span> Week(s)
                    </label>
                    <input type="range" id="settingsTimeframeSlider" min="1" max="12" value="6" style="width: 150px;"
                        oninput="document.getElementById('settingsTimeframeValue').innerText = this.value">
                </div>
            </div>

            <div style="display: flex; justify-content: flex-end;">
                <button class="btn" onclick="saveLayoutSettings()">Save Layout Settings</button>
            </div>
        </div>
    </div>

    <!-- Data Management Section -->
    <div class="settings-section">
        <div class="settings-section-header" onclick="toggleSettingsSection(this.parentElement)">
            <h2>Data & System</h2>
            <span class="chevron">‚ñº</span>
        </div>
        <div class="settings-section-content">
            <div class="setting-item"
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                <div>
                    <h4 style="margin: 0 0 5px 0;">Backup Data</h4>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Create a backup of all your JSON
                        data files.</p>
                </div>
                <button class="btn" onclick="triggerBackup()">Backup Now</button>
            </div>

            <div class="setting-item" style="display: flex; justify-content: space-between; align-items: center;">
                <div>
                    <h4 style="margin: 0 0 5px 0;">Application Update</h4>
                    <p style="margin: 0; color: var(--text-muted); font-size: 0.9rem;">Check for updates from the
                        repository.</p>
                </div>
                <button class="btn btn-secondary" onclick="checkUpdate()" id="checkUpdateBtn">Check Update</button>
            </div>
            <div id="updateStatus"
                style="margin-top: 10px; color: var(--text-muted); font-size: 0.8rem; text-align: right;"></div>
        </div>
    </div>

</div>

<!-- Init Settings Script -->
<script>
    function toggleSettingsSection(section) {
        const isActive = section.classList.contains('active');
        // Close other sections (optional, but requested "compact look" usually implies one at a time)
        document.querySelectorAll('.settings-section').forEach(s => s.classList.remove('active'));

        if (!isActive) {
            section.classList.add('active');
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        // Init properties
        const savedScheme = localStorage.getItem('colorScheme') || 'default';
        document.getElementById('colorSchemeSelect').value = savedScheme;

        const savedFont = localStorage.getItem('fontFamily') || "'Inter', sans-serif";
        document.getElementById('fontFamilySelect').value = savedFont;

        // Ensure theme radio is set correctly
        const savedTheme = localStorage.getItem('theme') || 'light';
        if (savedTheme === 'light') {
            document.getElementById('settingsLightTheme').checked = true;
        } else {
            document.getElementById('settingsDarkTheme').checked = true;
        }

        // Load Settings
        fetch('/api/settings')
            .then(res => res.json())
            .then(settings => {
                if (settings && settings.colors) {
                    document.getElementById('color2Weeks').value = settings.colors.nearing_2_weeks;
                    document.getElementById('color1Week').value = settings.colors.nearing_1_week;
                    document.getElementById('colorOverdue').value = settings.colors.overdue;
                    updateColorPreviews();
                }
                if (settings && settings.section_order) {
                    document.getElementById('sectionOrder0').value = settings.section_order[0];
                    document.getElementById('sectionOrder1').value = settings.section_order[1];
                    document.getElementById('sectionOrder2').value = settings.section_order[2];
                }
                if (settings && settings.timeframe) {
                    document.getElementById('settingsTimeframeSlider').value = settings.timeframe;
                    document.getElementById('settingsTimeframeValue').innerText = settings.timeframe;
                }
            });
    });

    function updateColorPreviews() {
        document.getElementById('preview2Weeks').style.backgroundColor = document.getElementById('color2Weeks').value;
        document.getElementById('preview1Week').style.backgroundColor = document.getElementById('color1Week').value;
        document.getElementById('previewOverdue').style.backgroundColor = document.getElementById('colorOverdue').value;
    }

    async function saveColorSettings() {
        const settingsRes = await fetch('/api/settings');
        const currentSettings = await settingsRes.json();

        const settings = {
            ...currentSettings,
            colors: {
                nearing_2_weeks: document.getElementById('color2Weeks').value,
                nearing_1_week: document.getElementById('color1Week').value,
                overdue: document.getElementById('colorOverdue').value
            }
        };

        await persistSettings(settings);
    }

    async function saveLayoutSettings() {
        const order = [
            document.getElementById('sectionOrder0').value,
            document.getElementById('sectionOrder1').value,
            document.getElementById('sectionOrder2').value
        ];

        // Check for duplicates
        if (new Set(order).size !== 3) {
            alert('Each section must be unique! Please choose a different order.');
            return;
        }

        const settingsRes = await fetch('/api/settings');
        const currentSettings = await settingsRes.json();

        const settings = {
            ...currentSettings,
            section_order: order,
            timeframe: document.getElementById('settingsTimeframeSlider').value
        };

        if (await persistSettings(settings)) {
            // Success! Clear local override so server-side order takes effect immediately on reload
            localStorage.removeItem('dashboardSectionOrder');
        }
    }

    async function persistSettings(settings) {
        try {
            const res = await fetch('/api/settings', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(settings)
            });
            if (res.ok) {
                alert('Settings saved successfully!');
                return true;
            } else {
                alert('Failed to save settings.');
                return false;
            }
        } catch (e) {
            alert('Error saving settings: ' + e);
            return false;
        }
    }

    async function triggerBackup() {
        try {
            const res = await fetch('/api/backup', { method: 'POST' });
            const data = await res.json();
            if (res.ok) {
                alert('Backup successful! Files saved to: ' + data.path);
            } else {
                alert('Backup failed: ' + data.error);
            }
        } catch (e) {
            alert('Error triggering backup: ' + e);
        }
    }

    async function saveUserName() {
        const nameInput = document.getElementById('userNameInput');
        const newName = nameInput.value.trim();
        if (!newName) {
            alert('Please enter a valid nickname.');
            return;
        }

        try {
            const res = await fetch('/api/settings/username', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: newName })
            });
            const data = await res.json();
            if (data.success) {
                alert('Nickname saved! It will reflect on the dashboard.');
            } else {
                alert('Error saving nickname: ' + data.error);
            }
        } catch (e) {
            alert('Error saving nickname: ' + e);
        }
    }

    async function checkUpdate() {
        const statusDiv = document.getElementById('updateStatus');
        const btn = document.getElementById('checkUpdateBtn');

        statusDiv.innerText = 'Checking...';
        btn.disabled = true;

        try {
            const res = await fetch('/api/check_update');
            const data = await res.json();

            if (data.update_available) {
                statusDiv.innerText = `${data.message} Remote: ${data.remote_date}, Local: ${data.local_date}`;
                statusDiv.style.color = 'var(--active-color)';
            } else {
                statusDiv.innerText = `${data.message} Last check: ${new Date().toLocaleTimeString()}`;
                statusDiv.style.color = 'var(--text-muted)';
            }
        } catch (e) {
            statusDiv.innerText = 'Error checking update.';
            statusDiv.style.color = 'red';
        } finally {
            btn.disabled = false;
        }
    }
</script>
{% endblock %}