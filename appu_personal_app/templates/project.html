{% extends "base.html" %}

{% block content %}
<div class="header">
    <div>
        <h1>{{ project.name }}</h1>
        <p style="color: var(--text-muted);">{{ project.description }}</p>
        <div style="margin-top: 10px; display: flex; gap: 10px; align-items: center;">
            <span class="status-badge status-{{ project.status.lower().replace(' ', '') }}">{{ project.status }}</span>
            <span style="color: var(--text-muted);">{{ project.start_date }} - {{ project.end_date }}</span>
        </div>
    </div>
    <div style="display: flex; gap: 10px;">
        <button class="btn" onclick="openEditProjectModal('{{ project.id }}', '{{ project.name|replace("'", "\\'") }}', '{{ project.description|replace("'", "\\'") }}', '{{ project.start_date }}', '{{ project.end_date }}', '{{ project.status }}')">âœï¸ Edit Project</button>
        <button class="btn btn-secondary" onclick="openCreateProjectTaskModal('{{ project.id }}')">â• New Task</button>
    </div>
</div>

<div class="project-tasks-container">
    <div class="section-header">
        <h3>ğŸ“‹ Tasks</h3>
    </div>
    <div id="tasksTree" class="tasks-tree">
        {% if project.tasks %}
        {% for task in project.tasks %}
        {% set project = project %}
        <div class="task-item" data-task-id="{{ task.id }}">
            <div class="task-item-header">
                <div class="task-item-content">
                    <div style="display: flex; align-items: center; gap: 10px;">
                        <span class="task-toggle" onclick="toggleTask(this)" data-expanded="false">â–¶</span>
                        <h4 class="task-item-title">{{ task.name }}</h4>
                        <span class="status-badge status-{{ task.status.lower().replace(' ', '') }}">{{ task.status }}</span>
                    </div>
                    <div class="task-item-meta">
                        <span>{{ task.start_date }} - {{ task.end_date }}</span>
                        <span style="margin-left: 10px; color: var(--text-muted);">ğŸ’¬ {{ task.task_comments|length if task.task_comments else 0 }} comments</span>
                        {% if task.task_comments and task.task_comments|length > 0 %}
                        <span style="margin-left: 10px; color: var(--text-muted); font-size: 0.85rem;">
                            {{ task.task_comments[-1].timestamp|short_date }}: {{ task.task_comments[-1].text[:50] }}{% if task.task_comments[-1].text|length > 50 %}...{% endif %}
                        </span>
                        {% endif %}
                    </div>
                </div>
                <div class="task-item-actions">
                    <button class="task-action-btn" onclick="event.stopPropagation(); openEditProjectTaskModal('{{ project.id }}', '{{ task.id }}', '{{ task.name|replace("'", "\\'") }}', '{{ task.comments|replace("'", "\\'") }}', '{{ task.start_date }}', '{{ task.end_date }}', '{{ task.status }}', '{{ task.start_date }}', '{{ task.end_date }}')" title="Edit Task">âœï¸</button>
                    <button class="task-action-btn" onclick="event.stopPropagation(); openCreateSubtaskModal('{{ project.id }}', '{{ task.id }}')" title="Add Subtask">â•</button>
                    <button class="task-action-btn" onclick="event.stopPropagation(); viewProjectTaskComments('{{ project.id }}', '{{ task.id }}', '{{ task.name|replace("'", "\\'") }}')" title="View Comments">ğŸ’¬</button>
                    <button class="task-action-btn delete-btn" data-type="project-tasks" data-project-id="{{ project.id }}" data-task-id="{{ task.id }}" title="Delete Task">ğŸ—‘ï¸</button>
                </div>
            </div>
            {% if task.comments %}
            <div class="task-item-description">
                <p>{{ task.comments }}</p>
            </div>
            {% endif %}
            <div class="task-subtasks" style="display: none;">
                {% if task.subtasks %}
                {% for subtask in task.subtasks %}
                {% set project = project %}
                {% set parent_start_date = task.start_date %}
                {% set parent_end_date = task.end_date %}
                {% include 'subtask_item.html' %}
                {% endfor %}
                {% endif %}
            </div>
        </div>
        {% endfor %}
        {% else %}
        <p style="text-align:center; color: var(--text-muted); padding: 20px;">No tasks yet. Create your first task!</p>
        {% endif %}
    </div>
</div>

<script>
    // Store project data for JavaScript
    window.currentProject = {{ project|tojson }};
    window.projectStartDate = '{{ project.start_date }}';
    window.projectEndDate = '{{ project.end_date }}';
</script>
{% endblock %}

