{% extends 'base.html' %}

{% block content %}
<section class="dashboard-header">
    <div class="header-content">
        <h1>Monthly Reminders</h1>
        <p>Manage your recurring monthly tasks.</p>
    </div>
</section>

<div class="glass-panel" style="padding: 2rem;">
    <div class="raw-table-container">
        <table class="raw-table">
            <thead>
                <tr>
                    <th>Day of Month</th>
                    <th>Title</th>
                    <th>Description</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="monthlyTableBody">
                <!-- Injected via JS -->
            </tbody>
        </table>
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', async () => {
        const tableBody = document.getElementById('monthlyTableBody');

        const fetchReminders = async () => {
            const res = await fetch('/api/reminders');
            return await res.json();
        };

        const loadMonthly = async () => {
            const reminders = await fetchReminders();
            // Filter for monthly or yearly recurrence
            const recurring = reminders.filter(r => r.recurrence === 'monthly');

            // Sort by day of month
            recurring.sort((a, b) => {
                const dayA = new Date(a.date).getDate();
                const dayB = new Date(b.date).getDate();
                return dayA - dayB;
            });

            tableBody.innerHTML = '';
            if (recurring.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="4" style="text-align:center;">No monthly reminders found.</td></tr>';
                return;
            }

            recurring.forEach(r => {
                const date = new Date(r.date);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${date.getDate()}${getOrdinal(date.getDate())}</td>
                    <td><strong>${r.title}</strong></td>
                    <td>${r.description || ''}</td>
                    <td>
                        <button class="action-btn btn-delete" data-id="${r.id}"><i class="fas fa-trash"></i></button>
                    </td>
                `;
                tableBody.appendChild(tr);
            });

            document.querySelectorAll('.btn-delete').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const id = e.target.closest('button').dataset.id;
                    if (confirm('Delete this monthly reminder?')) {
                        await fetch(`/api/reminders/${id}`, { method: 'DELETE' });
                        loadMonthly();
                    }
                });
            });
        };

        function getOrdinal(n) {
            var s = ["th", "st", "nd", "rd"];
            var v = n % 100;
            return s[(v - 20) % 10] || s[v] || s[0];
        }

        loadMonthly();
    });
</script>
{% endblock %}