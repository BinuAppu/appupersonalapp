{% extends "base.html" %}

{% block content %}
<div class="header">
    <h1>All Items</h1>

    <div style="display: flex; gap: 10px;">
        <input type="text" id="searchInput" placeholder="Search title..." style="width: 200px;" onkeyup="filterItems()">
        <button class="btn btn-secondary" onclick="openCreateModal('reminder')">ðŸ”” New Reminder</button>
        <button class="btn" onclick="openCreateModal('task')">âœ… New Task</button>
        <button class="btn btn-secondary" style="background-color: var(--accent-color);" onclick="openKBModal()">ðŸ§  New
            KB Item</button>
    </div>
</div>

<div class="tabs">
    <button class="tab-btn active" id="taskTabBtn" onclick="showTab('tasks')">âœ… Tasks ({{ tasks|length }})</button>
    <button class="tab-btn" id="reminderTabBtn" onclick="showTab('reminders')">ðŸ”” Reminders ({{ reminders|length
        }})</button>
    <button class="tab-btn" id="kbTabBtn" onclick="showTab('kb')">ðŸ§  Knowledge Base ({{ kb_items|length }})</button>
</div>

<div id="tasksTab" class="tab-content">
    <div class="card">
        <div class="filters">
            <label>Filter Status:</label>
            <select id="statusFilter" onchange="filterItems()">
                <option value="All">All Statuses</option>
                <option value="Yet to Start">Yet to Start</option>
                <option value="Pending">Pending</option>
                <option value="wip">In Progress</option>
                <option value="Onhold">On Hold</option>
                <option value="Completed">Completed</option>
            </select>
        </div>
        <table style="width: 100%; text-align: left; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--border-color);">
                    <th style="padding: 12px;">Title</th>
                    <th style="padding: 12px;">Status</th>
                    <th style="padding: 12px;">Description</th>
                    <th style="padding: 12px;">Comments</th>
                    <th style="padding: 12px;">Actions</th>
                </tr>
            </thead>
            <tbody id="taskTable">
                {% for task in tasks %}
                <tr style="border-bottom: 1px solid var(--border-color);" data-status="{{ task.status }}">
                    <td style="padding: 12px; font-weight: 600;">{{ task.title }}</td>
                    <td style="padding: 12px;"><span
                            class="status-badge status-{{ task.status.lower().replace(' ', '') }}">{{ task.status
                            }}</span></td>
                    <td style="padding: 12px; color: var(--text-muted);">{{ task.description }}</td>
                    <td style="padding: 12px;">
                        <span class="view-comments-link"
                            onclick="viewComments('task', '{{ task.id }}', '{{ task.title|replace("'", "\\'") }}')">ðŸ’¬
                            View ({{ task.comments|length }})</span>
                    </td>
                    <td style="padding: 12px; display: flex; gap: 8px;">
                        <button class="edit-btn" 
                            data-edit-type="task"
                            data-edit-id="{{ task.id }}"
                            data-edit-title="{{ task.title }}"
                            data-edit-description="{{ task.description }}"
                            data-edit-status="{{ task.status }}"
                            style="background:none; border:none; color: var(--primary-color); cursor:pointer; font-weight:600;">Edit</button>
                        <button class="delete-btn" data-type="tasks" data-id="{{ task.id }}"
                            style="background:none; border:none; color: #FF7575; cursor:pointer; font-weight:600;">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="remindersTab" class="tab-content" style="display: none;">
    <div class="card">
        <div class="filters">
            <label>Filter Recurrence:</label>
            <select id="recurrenceFilter" onchange="filterItems()">
                <option value="All">All Recurrences</option>
                <option value="None">No Recurrence</option>
                <option value="Daily">Daily</option>
                <option value="Weekly">Weekly</option>
                <option value="Monthly">Monthly</option>
                <option value="Yearly">Yearly</option>
            </select>
        </div>
        <table style="width: 100%; text-align: left; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--border-color);">
                    <th style="padding: 12px;">Title</th>
                    <th style="padding: 12px;">Date</th>
                    <th style="padding: 12px;">Recurrence</th>
                    <th style="padding: 12px;">Comments</th>
                    <th style="padding: 12px;">Actions</th>
                </tr>
            </thead>
            <tbody id="reminderTable">
                {% for rem in reminders %}
                <tr style="border-bottom: 1px solid var(--border-color);" data-recurrence="{{ rem.recurrence }}">
                    <td style="padding: 12px; font-weight: 600;">{{ rem.title }}</td>
                    <td style="padding: 12px;">{{ rem.date }}</td>
                    <td style="padding: 12px;">{{ rem.recurrence }}</td>
                    <td style="padding: 12px;">
                        <span class="view-comments-link"
                            onclick="viewComments('reminder', '{{ rem.id }}', '{{ rem.title|replace("'", "\\'") }}')">ðŸ’¬
                            View ({{ rem.comments|length }})</span>
                    </td>
                    <td style="padding: 12px; display: flex; gap: 8px;">
                        <button class="edit-btn"
                            data-edit-type="reminder"
                            data-edit-id="{{ rem.id }}"
                            data-edit-title="{{ rem.title }}"
                            data-edit-description="{{ rem.description }}"
                            data-edit-date="{{ rem.date }}"
                            data-edit-recurrence="{{ rem.recurrence }}"
                            style="background:none; border:none; color: var(--primary-color); cursor:pointer; font-weight:600;">Edit</button>
                        <button class="delete-btn" data-type="reminders" data-id="{{ rem.id }}"
                            style="background:none; border:none; color: #FF7575; cursor:pointer; font-weight:600;">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<div id="kbTab" class="tab-content" style="display: none;">
    <div class="card">
        <table style="width: 100%; text-align: left; border-collapse: collapse;">
            <thead>
                <tr style="border-bottom: 2px solid var(--border-color);">
                    <th style="padding: 12px;">Title</th>
                    <th style="padding: 12px;">Data</th>
                    <th style="padding: 12px;">URL</th>
                    <th style="padding: 12px;">Actions</th>
                </tr>
            </thead>
            <tbody id="kbTable">
                {% for item in kb_items %}
                <tr style="border-bottom: 1px solid var(--border-color);">
                    <td style="padding: 12px; font-weight: 600;">{{ item.title }}</td>
                    <td
                        style="padding: 12px; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                        {{ item.data }}</td>
                    <td style="padding: 12px;"><a href="{{ item.url }}" target="_blank"
                            style="color: var(--primary-color);">{{ item.url }}</a></td>
                    <td style="padding: 12px; display: flex; gap: 8px;">
                        <button onclick="openKBModal('{{ item.id }}')"
                            style="background:none; border:none; color: var(--primary-color); cursor:pointer; font-weight:600;">Edit</button>
                        <button onclick="deleteKBItem('{{ item.id }}')"
                            style="background:none; border:none; color: #FF7575; cursor:pointer; font-weight:600;">Delete</button>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<script>
    window.showTab = function (tab) {
        document.getElementById('tasksTab').style.display = tab === 'tasks' ? 'block' : 'none';
        document.getElementById('remindersTab').style.display = tab === 'reminders' ? 'block' : 'none';
        document.getElementById('kbTab').style.display = tab === 'kb' ? 'block' : 'none';

        document.getElementById('taskTabBtn').classList.toggle('active', tab === 'tasks');
        document.getElementById('reminderTabBtn').classList.toggle('active', tab === 'reminders');
        document.getElementById('kbTabBtn').classList.toggle('active', tab === 'kb');

        // Save the active tab
        localStorage.setItem('activeTab', tab);
        
        if (typeof filterItems === 'function') {
            filterItems();
        }
    }

    window.filterItems = function () {
        const searchInput = document.getElementById("searchInput");
        if (!searchInput) return;
        const searchFilter = searchInput.value.toUpperCase();

        // Tasks
        const statusFilter = document.getElementById("statusFilter")?.value || "All";
        const taskTable = document.getElementById("taskTable");
        if (taskTable) {
            const taskRows = taskTable.getElementsByTagName("tr");
            for (let i = 0; i < taskRows.length; i++) {
                const titleText = taskRows[i].getElementsByTagName("td")[0]?.textContent.toUpperCase() || '';
                const matchesSearch = titleText.indexOf(searchFilter) > -1;
                const matchesStatus = (statusFilter === "All" || taskRows[i].getAttribute("data-status") === statusFilter);
                taskRows[i].style.display = (matchesSearch && matchesStatus) ? "" : "none";
            }
        }

        // Reminders
        const recurrenceFilter = document.getElementById("recurrenceFilter")?.value || "All";
        const reminderTable = document.getElementById("reminderTable");
        if (reminderTable) {
            const remRows = reminderTable.getElementsByTagName("tr");
            for (let i = 0; i < remRows.length; i++) {
                const titleText = remRows[i].getElementsByTagName("td")[0]?.textContent.toUpperCase() || '';
                const matchesSearch = titleText.indexOf(searchFilter) > -1;
                const matchesRecur = (recurrenceFilter === "All" || remRows[i].getAttribute("data-recurrence") === recurrenceFilter);
                remRows[i].style.display = (matchesSearch && matchesRecur) ? "" : "none";
            }
        }

        // KB
        const kbTable = document.getElementById("kbTable");
        if (kbTable) {
            const kbRows = kbTable.getElementsByTagName("tr");
            for (let i = 0; i < kbRows.length; i++) {
                const titleText = kbRows[i].getElementsByTagName("td")[0]?.textContent.toUpperCase() || '';
                const matchesSearch = titleText.indexOf(searchFilter) > -1;
                kbRows[i].style.display = matchesSearch ? "" : "none";
            }
        }
    }
</script>
{% endblock %}